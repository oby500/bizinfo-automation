name: K-Startup Collection

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'ìˆ˜ì§‘ ëª¨ë“œ ì„ íƒ'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily    # ìµœê·¼ 200ê°œë§Œ í™•ì¸ (2-3ì´ˆ)
        - full     # ì „ì²´ 259í˜ì´ì§€ í™•ì¸ (30-60ì´ˆ)
  schedule:
    - cron: '0 22 * * *'  # ë§¤ì¼ ì˜¤ì „ 7ì‹œ (KST) - daily ëª¨ë“œë¡œ ì‹¤í–‰

jobs:
  collect:
    name: K-Startup ìˆ˜ì§‘ (${{ github.event.inputs.mode || 'daily' }})
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase python-dotenv lxml
    
    - name: Set Collection Mode
      id: mode
      run: |
        # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì‹œ daily, ìˆ˜ë™ ì‹¤í–‰ì‹œ ì„ íƒí•œ ëª¨ë“œ
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "mode=daily" >> $GITHUB_OUTPUT
          echo "ğŸ“… ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ì¼ì¼ ìˆ˜ì§‘ ëª¨ë“œ"
        else
          echo "mode=${{ github.event.inputs.mode || 'daily' }}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.mode || 'daily' }} ëª¨ë“œ"
        fi
    
    # ===== ìˆ˜ì§‘ ë‹¨ê³„ =====
    - name: ğŸ“¥ Daily Collection (ìµœê·¼ 200ê°œ)
      if: steps.mode.outputs.mode == 'daily'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸš€ ì¼ì¼ ìˆ˜ì§‘ ì‹œì‘ (ìµœê·¼ 200ê°œë§Œ í™•ì¸)"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/collect_kstartup_daily.py
    
    - name: ğŸ” Full Collection (ì „ì²´)
      if: steps.mode.outputs.mode == 'full'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“Š ì „ì²´ ìˆ˜ì§‘ ì‹œì‘ (259í˜ì´ì§€ ëª¨ë‘ í™•ì¸)"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/collect_kstartup_batch.py
    
    # ===== í›„ì²˜ë¦¬ ë‹¨ê³„ =====
    - name: ğŸ“ Parse Details (ìƒì„¸ íŒŒì‹±)
      if: success()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“ ìƒì„¸ ë‚´ìš© ë³‘ë ¬ íŒŒì‹±..."
        python scripts/kstartup_parallel_parser.py
      continue-on-error: true
    
    - name: ğŸ“ Process Attachments
      if: success()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“ ì²¨ë¶€íŒŒì¼ ì •ë³´ ì²˜ë¦¬..."
        python scripts/kstartup_attachment_fix.py
      continue-on-error: true
    
    # ===== ê²°ê³¼ ë³´ê³  =====
    - name: ğŸ“Š Final Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        python -c "
        import os
        from supabase import create_client
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_KEY')
        supabase = create_client(url, key)
        
        print('\\n' + '='*60)
        print('ğŸ“Š K-Startup ìˆ˜ì§‘ ê²°ê³¼')
        print('='*60)
        
        # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
        today = datetime.now().date().isoformat()
        new = supabase.table('kstartup_complete').select('biz_pbanc_nm, status, recept_end_dt').gte('created_at', today).execute()
        
        if new.data:
            print(f'âœ… ì˜¤ëŠ˜ ì¶”ê°€: {len(new.data)}ê°œ')
            for item in new.data[:5]:
                print(f\"  â€¢ [{item['status']}] {item['biz_pbanc_nm'][:45]}\")
            if len(new.data) > 5:
                print(f'  ... ì™¸ {len(new.data)-5}ê°œ')
        else:
            print('â„¹ï¸ ì˜¤ëŠ˜ ì¶”ê°€ëœ ê³µê³  ì—†ìŒ')
        
        # ì „ì²´ í†µê³„
        total = supabase.table('kstartup_complete').select('id').execute()
        active = supabase.table('kstartup_complete').select('id').in_('status', ['ëª¨ì§‘ì¤‘', 'ë§ˆê°ì„ë°•']).execute()
        
        print(f'\\nğŸ“ˆ ì „ì²´ í†µê³„:')
        print(f'  â€¢ ì „ì²´: {len(total.data)}ê°œ')
        print(f'  â€¢ í™œì„±: {len(active.data)}ê°œ (ëª¨ì§‘ì¤‘/ë§ˆê°ì„ë°•)')
        print('='*60)
        "
