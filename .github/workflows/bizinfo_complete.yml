name: Bizinfo Complete Processing

on:
  schedule:
    # í‰ì¼ ì˜¤í›„ 5ì‹œ ì‹¤í–‰ (KST) = UTC 08:00
    - cron: '0 8 * * 1-5'  # ì›”-ê¸ˆ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  collect-and-process:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # ìµœëŒ€ 2ì‹œê°„
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install selenium webdriver-manager
        pip install pandas openpyxl
        pip install requests beautifulsoup4
        pip install supabase
    
    - name: Step 1 - Collect Bizinfo Data (Excel Download)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== Step 1: ê¸°ì—…ë§ˆë‹¹ ë°ì´í„° ìˆ˜ì§‘ ==="
        python scripts/bizinfo_excel_collector.py
      continue-on-error: false  # ì‹¤íŒ¨ì‹œ ì¤‘ë‹¨
    
    - name: Wait before processing
      run: |
        echo "ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ. 10ì´ˆ ëŒ€ê¸°..."
        sleep 10
    
    - name: Step 2 - Process Attachments and Hashtags
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== Step 2: ì²¨ë¶€íŒŒì¼ í¬ë¡¤ë§ ë° í•´ì‹œíƒœê·¸ ìƒì„± ==="
        python scripts/bizinfo_complete_processor.py
    
    - name: Generate Summary Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½ ==="
        python -c "
import os
from supabase import create_client
from datetime import datetime, timedelta

try:
    url = os.environ.get('SUPABASE_URL')
    key = os.environ.get('SUPABASE_KEY')
    supabase = create_client(url, key)
    
    # ì˜¤ëŠ˜ ì²˜ë¦¬ëœ ë°ì´í„° ì¡°íšŒ
    today = datetime.now().date()
    
    # ì „ì²´ ë°ì´í„° ìˆ˜
    total_result = supabase.table('bizinfo_complete').select('id').execute()
    total_count = len(total_result.data) if total_result.data else 0
    
    # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
    today_str = today.isoformat()
    today_result = supabase.table('bizinfo_complete').select('id').gte('created_at', today_str).execute()
    today_count = len(today_result.data) if today_result.data else 0
    
    # ì²¨ë¶€íŒŒì¼ ìˆëŠ” ë°ì´í„°
    attachment_result = supabase.table('bizinfo_complete').select('id').gt('attachment_count', 0).execute()
    attachment_count = len(attachment_result.data) if attachment_result.data else 0
    
    print(f'ğŸ“Š ê¸°ì—…ë§ˆë‹¹ ì²˜ë¦¬ í˜„í™©')
    print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    print(f'ì „ì²´ ë°ì´í„°: {total_count}ê°œ')
    print(f'ì˜¤ëŠ˜ ì¶”ê°€: {today_count}ê°œ')
    print(f'ì²¨ë¶€íŒŒì¼ ë³´ìœ : {attachment_count}ê°œ')
    print(f'ì²˜ë¦¬ ì‹œê°„: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')'
except Exception as e:
    print(f'í†µê³„ ìƒì„± ì‹¤íŒ¨: {e}')"
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bizinfo-logs-${{ github.run_number }}
        path: |
          *.log
          downloads/*.xlsx
        retention-days: 7
