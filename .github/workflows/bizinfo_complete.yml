name: ğŸ¢ Bizinfo Complete Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1-5'  # í‰ì¼ ì˜¤í›„ 5ì‹œ (KST)

jobs:
  collect:
    name: ê¸°ì—…ë§ˆë‹¹ ì™„ì „ ìë™ ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install dependencies
      run: |
        pip install selenium webdriver-manager pandas openpyxl
        pip install requests beautifulsoup4 supabase
    
    - name: Step 1 - Excel Collection
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 1: ê¸°ì—…ë§ˆë‹¹ ì—‘ì…€ ë°ì´í„° ìˆ˜ì§‘"
        echo "======================================"
        python scripts/bizinfo_excel_collector.py
    
    - name: Step 2 - Detail Page Crawling (Selenium)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 2: ìƒì„¸í˜ì´ì§€ í¬ë¡¤ë§ (Selenium)"
        echo "======================================"
        python scripts/bizinfo_detail_crawler_selenium.py
    
    - name: Step 3 - Attachment Processing
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 3: ì²¨ë¶€íŒŒì¼ ì •ë¦¬"
        echo "======================================"
        python scripts/bizinfo_complete_processor_fast.py
    
    - name: Generate Final Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜: SUPABASE_URL ë˜ëŠ” SUPABASE_SERVICE_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            exit(1)
            
        supabase = create_client(url, key)
        
        try:
            # ì „ì²´ í†µê³„
            total = supabase.table('bizinfo_complete').select('id').execute()
            total_count = len(total.data) if total.data else 0
            
            # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
            today = datetime.now().date().isoformat()
            today_new = supabase.table('bizinfo_complete').select('id').gte('regist_dt', today).execute()
            today_count = len(today_new.data) if today_new.data else 0
            
            # ì •ìƒ ìš”ì•½ ë³´ìœ  ë°ì´í„° (200ì ì´ìƒ)
            all_data = supabase.table('bizinfo_complete').select('id,bsns_sumry').execute()
            if all_data.data:
                with_summary = sum(1 for item in all_data.data 
                                 if item.get('bsns_sumry') and len(item['bsns_sumry']) > 200)
            else:
                with_summary = 0
            
            # ì²¨ë¶€íŒŒì¼ ë³´ìœ  ë°ì´í„°
            with_attach = supabase.table('bizinfo_complete').select('id').neq('attachment_urls', '[]').execute()
            attach_count = len(with_attach.data) if with_attach.data else 0
            
            print('\n' + '='*60)
            print('      ğŸ¢ ê¸°ì—…ë§ˆë‹¹ ì²˜ë¦¬ ê²°ê³¼ ë³´ê³ ì„œ')
            print('='*60)
            print(f'ğŸ“Š ì „ì²´ ë°ì´í„°: {total_count}ê°œ')
            print(f'ğŸ“Š ì˜¤ëŠ˜ ì‹ ê·œ ì¶”ê°€: {today_count}ê°œ')
            print(f'ğŸ“Š ì •ìƒ ìš”ì•½ ë³´ìœ : {with_summary}ê°œ ({with_summary*100/total_count:.1f}%)')
            print(f'ğŸ“Š ì²¨ë¶€íŒŒì¼ ë³´ìœ : {attach_count}ê°œ ({attach_count*100/total_count:.1f}%)')
            
            # í’ˆì§ˆ ì²´í¬
            quality_score = (with_summary / total_count * 100) if total_count > 0 else 0
            attach_score = (attach_count / total_count * 100) if total_count > 0 else 0
            
            print('\nğŸ“ˆ í’ˆì§ˆ í‰ê°€:')
            if quality_score >= 90:
                print('  âœ… ìš”ì•½ í’ˆì§ˆ: ìš°ìˆ˜ (90% ì´ìƒ)')
            elif quality_score >= 70:
                print('  âš ï¸ ìš”ì•½ í’ˆì§ˆ: ë³´í†µ (70-90%)')
            else:
                print('  âŒ ìš”ì•½ í’ˆì§ˆ: ê°œì„  í•„ìš” (70% ë¯¸ë§Œ)')
            
            if attach_score >= 90:
                print('  âœ… ì²¨ë¶€íŒŒì¼: ìš°ìˆ˜ (90% ì´ìƒ)')
            elif attach_score >= 70:
                print('  âš ï¸ ì²¨ë¶€íŒŒì¼: ë³´í†µ (70-90%)')
            else:
                print('  âŒ ì²¨ë¶€íŒŒì¼: ê°œì„  í•„ìš” (70% ë¯¸ë§Œ)')
            
            if today_count > 0:
                print(f'\nâœ… ì˜¤ëŠ˜ {today_count}ê°œ ì²˜ë¦¬ ì„±ê³µ!')
            else:
                print('\nâš ï¸ ì˜¤ëŠ˜ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
            
            print('='*60)
            
        except Exception as e:
            print(f"ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            exit(1)
        EOF
        python report.py
