name: ğŸ¢ Bizinfo Complete Workflow

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'ìˆ˜ì§‘ ëª¨ë“œ'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily    # ìµœê·¼ 7ì¼ ë°ì´í„°ë§Œ (ë¹ ë¥¸ ì²˜ë¦¬)
        - full     # ì „ì²´ ë°ì´í„° ì²˜ë¦¬ (ì™„ì „ ì ê²€)
  schedule:
    - cron: '0 8 * * 1-5'  # í‰ì¼ ì˜¤í›„ 5ì‹œ (KST)

jobs:
  collect:
    name: ê¸°ì—…ë§ˆë‹¹ ì™„ì „ ìë™ ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase pandas openpyxl
        pip install selenium webdriver-manager python-dotenv chardet
    
    - name: Determine Mode
      id: mode
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "mode=daily" >> $GITHUB_OUTPUT
          echo "ğŸ“… ìŠ¤ì¼€ì¤„ ì‹¤í–‰: daily ëª¨ë“œ"
        else
          echo "mode=${{ github.event.inputs.mode || 'daily' }}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.mode || 'daily' }} ëª¨ë“œ"
        fi
    
    - name: Step 0 - Data Normalization
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 0: ë°ì´í„° ì •ê·œí™”"
        echo "======================================"
        echo "ğŸ”§ attachment_urls ë°ì´í„° íƒ€ì… ì •ê·œí™”"
        echo "ë¬¸ìì—´ë¡œ ì €ì¥ëœ ë°ì´í„°ë¥¼ JSON ë°°ì—´ë¡œ ë³€í™˜"
        python scripts/bizinfo_normalize_attachments.py
    
    - name: Step 1 - Excel Collection
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 1: ê¸°ì—…ë§ˆë‹¹ ì—‘ì…€ ë°ì´í„° ìˆ˜ì§‘"
        echo "======================================"
        echo "ğŸ” ëª¨ë“œ: ${{ steps.mode.outputs.mode }}"
        python scripts/bizinfo_excel_collector.py
    
    - name: Step 2 - Daily Mode Crawler
      if: steps.mode.outputs.mode == 'daily'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 2: Daily ëª¨ë“œ - K-Startup ë°©ì‹ ì²˜ë¦¬"
        echo "======================================"
        echo "ìµœê·¼ 7ì¼ ë°ì´í„° ì¤‘ DOC/HTML íƒ€ì… ë° 'ë‹¤ìš´ë¡œë“œ' íŒŒì¼ëª… ìˆ˜ì •..."
        
        # K-Startup ë°©ì‹ìœ¼ë¡œ íŒŒì¼ ì •ë³´ ìˆ˜ì • (Daily ëª¨ë“œìš© ìˆ˜ì •)
        sed -i 's/\.execute()/\.gte("created_at", (datetime.now() - timedelta(days=7)).isoformat()).execute()/' scripts/bizinfo_attachment_fix_kstartup_style.py
        
        # datetime import ì¶”ê°€
        sed -i '1a from datetime import datetime, timedelta' scripts/bizinfo_attachment_fix_kstartup_style.py
        
        python scripts/bizinfo_attachment_fix_kstartup_style.py || echo "STEP 2 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
    
    - name: Step 2 - Full Mode Crawler  
      if: steps.mode.outputs.mode == 'full'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 2: Full ëª¨ë“œ - K-Startup ë°©ì‹ ì „ì²´ ì²˜ë¦¬"
        echo "======================================"
        echo "ì „ì²´ ë°ì´í„° ì ê²€ ë° íŒŒì¼ ì •ë³´ ì •í™•ë„ ê°œì„ ..."
        echo "K-Startup ë°©ì‹: HEAD ìš”ì²­ + íŒŒì¼ ì‹œê·¸ë‹ˆì²˜ë¡œ ì •í™•í•œ íƒ€ì… íŒë³„"
        
        # K-Startup ë°©ì‹ìœ¼ë¡œ ì „ì²´ ì²˜ë¦¬
        python scripts/bizinfo_attachment_fix_kstartup_style.py || echo "STEP 2 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
    
    - name: Step 3 - Attachment Processing
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 3: ì²¨ë¶€íŒŒì¼ ì •ë¦¬"
        echo "======================================"
        python scripts/bizinfo_attachment_crawler.py || echo "Attachment crawler ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
          python scripts/bizinfo_complete_processor_fast.py || echo "STEP 3 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
    
    - name: Step 4 - Fix All Filename Issues
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 4: ê¹¨ì§„ íŒŒì¼ëª… ì™„ì „ í•´ê²°"
        echo "======================================"
        echo "ğŸ”§ 3ë‹¨ê³„ ë³µêµ¬ ì „ëµ:"
        echo "  1. HTML div.file_nameì—ì„œ ì •í™•í•œ íŒŒì¼ëª… ì¶”ì¶œ"
        echo "  2. íŒ¨í„´ ê¸°ë°˜ ì¸ì½”ë”© ìˆ˜ì •"
        echo "  3. ê³µê³ ëª… ê¸°ë°˜ ìƒˆ íŒŒì¼ëª… ìƒì„±"
        echo ""
        
        # ê¸´ê¸‰ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (HTML + íŒ¨í„´ + ìƒì„±)
        if [ -f "scripts/bizinfo_filename_emergency_fix.py" ]; then
            echo "âœ… ê°•í™”ëœ 3ë‹¨ê³„ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
            python scripts/bizinfo_filename_emergency_fix.py || echo "STEP 4 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
        elif [ -f "scripts/bizinfo_html_filename_fix.py" ]; then
            echo "âš ï¸ HTML ì¬í¬ë¡¤ë§ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
            python scripts/bizinfo_html_filename_fix.py || echo "STEP 4 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
        else
            echo "âš ï¸ ê¸°ë³¸ ì¸ì½”ë”© ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
            python scripts/bizinfo_encoding_complete_fix.py || echo "STEP 4 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
        fi
    
    - name: Step 5 - Fix Legacy Data Issues
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "======================================"
        echo "  STEP 5: ë ˆê±°ì‹œ ë°ì´í„° ë¬¸ì œ í•´ê²°"
        echo "======================================"
        echo "ğŸš¨ ë¬¸ì œ íƒ€ì… ìˆ˜ì •:"
        echo "  - type='getImageFile' â†’ ì‹¤ì œ íŒŒì¼ íƒ€ì…ìœ¼ë¡œ ë³€í™˜"
        echo "  - type='DOC/HTML/UNKNOWN' â†’ ì ì ˆí•œ íƒ€ì…ìœ¼ë¡œ ë³€í™˜"
        echo "  - íŒŒì¼ëª…='ë‹¤ìš´ë¡œë“œ' â†’ ì‹¤ì œ íŒŒì¼ëª… ìƒì„±"
        echo "ğŸ“Š ëŒ€ìƒ: 8ì›” 5ì¼ ë°ì´í„° í¬í•¨ ì „ì²´ ë¬¸ì œ íŒŒì¼"
        python scripts/bizinfo_aug5_data_fix.py || echo "STEP 5 ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
    
    - name: Generate Final Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        import json
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜: SUPABASE_URL ë˜ëŠ” SUPABASE_SERVICE_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            exit(1)
            
        supabase = create_client(url, key)
        
        # ì‹¤í–‰ ëª¨ë“œ í™•ì¸
        mode = os.environ.get('MODE', 'unknown')
        
        try:
            # ì „ì²´ í†µê³„
            total = supabase.table('bizinfo_complete').select('id').execute()
            total_count = len(total.data) if total.data else 0
            
            # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
            today = datetime.now().date().isoformat()
            today_new = supabase.table('bizinfo_complete').select('id').gte('created_at', today).execute()
            today_count = len(today_new.data) if today_new.data else 0
            
            # ì •ìƒ ìš”ì•½ ë³´ìœ  ë°ì´í„° (150ì ì´ìƒ)
            all_data = supabase.table('bizinfo_complete').select('id,bsns_sumry').limit(1000).execute()
            if all_data.data:
                with_summary = sum(1 for item in all_data.data 
                                 if item.get('bsns_sumry') and len(item['bsns_sumry']) > 150)
            else:
                with_summary = 0
            
            # ì²¨ë¶€íŒŒì¼ ë³´ìœ  ë°ì´í„° ë° íƒ€ì… ë¶„ì„
            with_attach = supabase.table('bizinfo_complete').select('id,attachment_urls').limit(1000).execute()
            attach_count = 0
            doc_count = 0
            hwp_count = 0
            pdf_count = 0
            download_count = 0
            broken_count = 0
            getimagefile_count = 0
            unknown_count = 0
            html_count = 0
            
            # ê¹¨ì§„ ë¬¸ì íŒ¨í„´
            broken_patterns = ['Ã¢', 'Ã¬', 'Ã«', 'Ã­', 'Ãª', 'Ã£', 'Ã°', 'Ã¾', 'Ã¯', 'Â¿', 'Â½', 'Ãƒ', 'Ã‚']
            
            for item in with_attach.data:
                attachments = item.get('attachment_urls')
                if attachments:
                    # ë¬¸ìì—´ì¸ ê²½ìš° JSON íŒŒì‹±
                    if isinstance(attachments, str):
                        try:
                            attachments = json.loads(attachments)
                        except:
                            continue
                    
                    if isinstance(attachments, list) and len(attachments) > 0:
                        attach_count += 1
                        for att in attachments:
                            if isinstance(att, dict):
                                file_type = att.get('type', '')
                                filename = att.get('display_filename', '')
                                
                                if file_type == 'getImageFile':
                                    getimagefile_count += 1
                                elif file_type == 'DOC':
                                    doc_count += 1
                                elif file_type == 'HTML':
                                    html_count += 1
                                elif file_type == 'UNKNOWN':
                                    unknown_count += 1
                                elif file_type == 'HWP':
                                    hwp_count += 1
                                elif file_type == 'PDF':
                                    pdf_count += 1
                                    
                                if filename == 'ë‹¤ìš´ë¡œë“œ':
                                    download_count += 1
                                # ê¹¨ì§„ íŒŒì¼ëª… ì²´í¬
                                if any(pattern in filename for pattern in broken_patterns):
                                    broken_count += 1
            
            print('\n' + '='*60)
            print('      ğŸ¢ ê¸°ì—…ë§ˆë‹¹ ì²˜ë¦¬ ê²°ê³¼ ë³´ê³ ì„œ')
            print('='*60)
            print(f'ğŸ” ì‹¤í–‰ ëª¨ë“œ: {mode.upper()}')
            print(f'ğŸ“Š ì „ì²´ ë°ì´í„°: {total_count}ê°œ')
            print(f'ğŸ“Š ì˜¤ëŠ˜ ì‹ ê·œ ì¶”ê°€: {today_count}ê°œ')
            print(f'ğŸ“Š ì •ìƒ ìš”ì•½ ë³´ìœ  (ìƒ˜í”Œ 1000ê°œ): {with_summary}ê°œ ({with_summary*100/min(1000, total_count):.1f}%)')
            print(f'ğŸ“Š ì²¨ë¶€íŒŒì¼ ë³´ìœ  (ìƒ˜í”Œ 1000ê°œ): {attach_count}ê°œ ({attach_count*100/min(1000, total_count):.1f}%)')
            
            # íŒŒì¼ íƒ€ì… ë¶„í¬
            print(f'\nğŸ“ íŒŒì¼ íƒ€ì… ë¶„í¬ (ìƒ˜í”Œ 1000ê°œ):')
            print(f'   - HWP: {hwp_count}ê°œ âœ…')
            print(f'   - PDF: {pdf_count}ê°œ âœ…')
            
            # ë¬¸ì œ íƒ€ì…ë“¤
            problem_types = []
            if getimagefile_count > 0:
                problem_types.append(f'   - getImageFile: {getimagefile_count}ê°œ âš ï¸ íƒ€ì… ì˜¤ë¥˜')
            if doc_count > 0:
                problem_types.append(f'   - DOC: {doc_count}ê°œ âš ï¸ ìˆ˜ì • í•„ìš”')
            if html_count > 0:
                problem_types.append(f'   - HTML: {html_count}ê°œ âš ï¸ ìˆ˜ì • í•„ìš”')
            if unknown_count > 0:
                problem_types.append(f'   - UNKNOWN: {unknown_count}ê°œ âš ï¸ ìˆ˜ì • í•„ìš”')
            
            if problem_types:
                print('\nğŸš¨ ë¬¸ì œ íƒ€ì…:')
                for pt in problem_types:
                    print(pt)
            
            if download_count > 0:
                print(f'\nğŸ“ íŒŒì¼ëª… ë¬¸ì œ:')
                print(f'   - "ë‹¤ìš´ë¡œë“œ" íŒŒì¼ëª…: {download_count}ê°œ âš ï¸')
            if broken_count > 0:
                print(f'   - ê¹¨ì§„ íŒŒì¼ëª…: {broken_count}ê°œ âš ï¸')
            
            # ìµœê·¼ ë°ì´í„° ìƒíƒœ ì ê²€
            recent = supabase.table('bizinfo_complete').select('id,attachment_urls,bsns_sumry,created_at').order('created_at', desc=True).limit(100).execute()
            if recent.data:
                recent_with_attach = sum(1 for item in recent.data 
                                       if item.get('attachment_urls') and item['attachment_urls'] != [])
                recent_with_summary = sum(1 for item in recent.data 
                                        if item.get('bsns_sumry') and len(item['bsns_sumry']) > 150)
                recent_broken = 0
                recent_getimagefile = 0
                for item in recent.data:
                    attachments = item.get('attachment_urls')
                    if attachments:
                        # ë¬¸ìì—´ ì²˜ë¦¬
                        if isinstance(attachments, str):
                            try:
                                attachments = json.loads(attachments)
                            except:
                                continue
                        
                        if isinstance(attachments, list):
                            for att in attachments:
                                if isinstance(att, dict):
                                    filename = att.get('display_filename', '')
                                    file_type = att.get('type', '')
                                    if any(pattern in filename for pattern in broken_patterns):
                                        recent_broken += 1
                                        break
                                    if file_type == 'getImageFile':
                                        recent_getimagefile += 1
                                        break
                
                print(f'\nğŸ“Œ ìµœê·¼ 100ê°œ ë°ì´í„°:')
                print(f'   - ì²¨ë¶€íŒŒì¼ ë³´ìœ : {recent_with_attach}ê°œ ({recent_with_attach}%)')
                print(f'   - ì •ìƒ ìš”ì•½: {recent_with_summary}ê°œ ({recent_with_summary}%)')
                if recent_broken > 0:
                    print(f'   - ê¹¨ì§„ íŒŒì¼ëª…: {recent_broken}ê°œ âš ï¸')
                if recent_getimagefile > 0:
                    print(f'   - getImageFile íƒ€ì…: {recent_getimagefile}ê°œ âš ï¸')
                
                if recent_with_attach < 70:
                    print('   âš ï¸ ê²½ê³ : ìµœê·¼ ë°ì´í„° ì²¨ë¶€íŒŒì¼ ìˆ˜ì§‘ë¥ ì´ ë‚®ìŠµë‹ˆë‹¤!')
                if recent_with_summary < 70:
                    print('   âš ï¸ ê²½ê³ : ìµœê·¼ ë°ì´í„° ìš”ì•½ í’ˆì§ˆì´ ë‚®ìŠµë‹ˆë‹¤!')
            
            # í’ˆì§ˆ ì²´í¬
            quality_score = (with_summary / min(1000, total_count) * 100) if total_count > 0 else 0
            attach_score = (attach_count / min(1000, total_count) * 100) if total_count > 0 else 0
            
            print('\nğŸ“ˆ í’ˆì§ˆ í‰ê°€:')
            if quality_score >= 90:
                print('  âœ… ìš”ì•½ í’ˆì§ˆ: ìš°ìˆ˜ (90% ì´ìƒ)')
            elif quality_score >= 70:
                print('  âš ï¸ ìš”ì•½ í’ˆì§ˆ: ë³´í†µ (70-90%)')
            else:
                print('  âŒ ìš”ì•½ í’ˆì§ˆ: ê°œì„  í•„ìš” (70% ë¯¸ë§Œ)')
            
            if attach_score >= 90:
                print('  âœ… ì²¨ë¶€íŒŒì¼: ìš°ìˆ˜ (90% ì´ìƒ)')
            elif attach_score >= 70:
                print('  âš ï¸ ì²¨ë¶€íŒŒì¼: ë³´í†µ (70-90%)')
            else:
                print('  âŒ ì²¨ë¶€íŒŒì¼: ê°œì„  í•„ìš” (70% ë¯¸ë§Œ)')
            
            # ë¬¸ì œ í‰ê°€
            total_problems = getimagefile_count + doc_count + html_count + unknown_count + broken_count + download_count
            if total_problems == 0:
                print('  âœ… íŒŒì¼ íƒ€ì…: ì™„ë²½ (ë¬¸ì œ ì—†ìŒ)')
            elif total_problems < 10:
                print(f'  âš ï¸ íŒŒì¼ íƒ€ì…: {total_problems}ê°œ ë¬¸ì œ ê°ì§€ (ë¯¸ë¯¸í•¨)')
            else:
                print(f'  ğŸš¨ íŒŒì¼ íƒ€ì…: {total_problems}ê°œ ë¬¸ì œ ê°ì§€ (ì²˜ë¦¬ í•„ìš”)')
            
            # ëª¨ë“œë³„ ì²˜ë¦¬ ë°©ì‹ ì•ˆë‚´
            print('\nğŸ”§ ì²˜ë¦¬ ë‹¨ê³„:')
            print('  STEP 0: ë°ì´í„° ì •ê·œí™”')
            print('  STEP 1: ì—‘ì…€ ë°ì´í„° ìˆ˜ì§‘')
            print('  STEP 2: K-Startup ë°©ì‹ ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬')
            print('  STEP 3: ì²¨ë¶€íŒŒì¼ ì •ë¦¬')
            print('  STEP 4: ê¹¨ì§„ íŒŒì¼ëª… ì™„ì „ í•´ê²° (3ë‹¨ê³„ ë³µêµ¬)')
            print('  STEP 5: ë ˆê±°ì‹œ ë°ì´í„° ë¬¸ì œ í•´ê²°')
            
            if today_count > 0:
                print(f'\nâœ… ì˜¤ëŠ˜ {today_count}ê°œ ì²˜ë¦¬ ì„±ê³µ!')
            else:
                print('\nâš ï¸ ì˜¤ëŠ˜ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
            
            # K-Startup ìƒíƒœë„ í™•ì¸
            k_total = supabase.table('kstartup_complete').select('id').execute()
            k_total_count = len(k_total.data) if k_total.data else 0
            print(f'\nğŸ“Š K-Startup í˜„í™©: {k_total_count}ê°œ (ì°¸ê³ )')
            
            print('='*60)
            
        except Exception as e:
            print(f"ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            exit(1)
        EOF
        MODE=${{ steps.mode.outputs.mode }} python report.py
