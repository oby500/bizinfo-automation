name: ğŸ”§ BizInfo íŒŒì¼ íƒ€ì… ìˆ˜ì •

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'ìˆ˜ì • íƒ€ì…'
        required: true
        default: 'all'
        type: choice
        options:
          - all           # ëª¨ë“  ë¬¸ì œ ìˆ˜ì •
          - getImageFile  # getImageFile íƒ€ì…ë§Œ
          - encoding      # ì¸ì½”ë”© ë¬¸ì œë§Œ
          - doc_unknown   # DOC/UNKNOWN íƒ€ì…ë§Œ

jobs:
  fix-filetypes:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install supabase requests
    
    - name: ìˆ˜ì • ì „ ìƒíƒœ í™•ì¸
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        python -c "
        import os
        from supabase import create_client
        
        supabase = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY'))
        
        # ë¬¸ì œ íŒŒì¼ íƒ€ì… ì¹´ìš´íŠ¸
        query = '''
        WITH file_types AS (
            SELECT 
                jsonb_array_elements(attachment_urls)->>'type' as file_type
            FROM bizinfo_complete
            WHERE attachment_urls IS NOT NULL AND attachment_urls != '[]'::jsonb
        )
        SELECT 
            file_type,
            COUNT(*) as count
        FROM file_types
        WHERE file_type IN ('getImageFile', 'DOC', 'UNKNOWN', 'HTML')
        GROUP BY file_type
        ORDER BY count DESC
        '''
        
        response = supabase.rpc('execute_sql', {'query': query}).execute()
        
        print('='*50)
        print('í˜„ì¬ ë¬¸ì œ íŒŒì¼ íƒ€ì… í˜„í™©:')
        print('='*50)
        
        total = 0
        if response.data:
            for row in response.data:
                print(f\"  - {row['file_type']}: {row['count']}ê°œ\")
                total += row['count']
            print(f'\nì´ {total}ê°œ íŒŒì¼ ìˆ˜ì • í•„ìš”')
        else:
            print('ìˆ˜ì •í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.')
        "
    
    - name: íŒŒì¼ íƒ€ì… ìˆ˜ì • ì‹¤í–‰
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        FIX_TYPE: ${{ github.event.inputs.fix_type }}
      run: |
        echo "ìˆ˜ì • íƒ€ì…: $FIX_TYPE"
        python scripts/bizinfo_filetype_complete_fix.py
    
    - name: ìˆ˜ì • í›„ ê²°ê³¼ í™•ì¸
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        python -c "
        import os
        from supabase import create_client
        
        supabase = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY'))
        
        # ì „ì²´ íŒŒì¼ íƒ€ì… ë¶„í¬
        query = '''
        WITH file_types AS (
            SELECT 
                jsonb_array_elements(attachment_urls)->>'type' as file_type
            FROM bizinfo_complete
            WHERE attachment_urls IS NOT NULL AND attachment_urls != '[]'::jsonb
        )
        SELECT 
            file_type,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
        FROM file_types
        GROUP BY file_type
        ORDER BY count DESC
        '''
        
        response = supabase.rpc('execute_sql', {'query': query}).execute()
        
        print('='*50)
        print('ìˆ˜ì • í›„ ì „ì²´ íŒŒì¼ íƒ€ì… ë¶„í¬:')
        print('='*50)
        
        if response.data:
            for row in response.data:
                print(f\"  - {row['file_type']}: {row['count']}ê°œ ({row['percentage']}%)\")
        
        # ê¹¨ì§„ íŒŒì¼ëª… í™•ì¸
        query2 = '''
        SELECT COUNT(*) as broken_count
        FROM bizinfo_complete
        WHERE attachment_urls IS NOT NULL 
        AND (
            attachment_urls::text LIKE '%Ãƒ%' OR
            attachment_urls::text LIKE '%Ã‚%'
        )
        '''
        
        response2 = supabase.rpc('execute_sql', {'query': query2}).execute()
        
        if response2.data:
            print(f\"\nê¹¨ì§„ íŒŒì¼ëª… ë‚¨ì€ ê°œìˆ˜: {response2.data[0]['broken_count']}ê°œ\")
        "
    
    - name: ìµœì¢… ë³´ê³ ì„œ
      run: |
        echo "================================"
        echo "BizInfo íŒŒì¼ íƒ€ì… ìˆ˜ì • ì™„ë£Œ"
        echo "================================"
        echo ""
        echo "âœ… ìˆ˜ì • ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        echo ""
        echo "ì£¼ìš” ê°œì„ ì‚¬í•­:"
        echo "1. getImageFile íƒ€ì… â†’ ì‹¤ì œ íŒŒì¼ íƒ€ì…ìœ¼ë¡œ ë³€í™˜"
        echo "2. DOC íƒ€ì… â†’ ëŒ€ë¶€ë¶„ HWPë¡œ ìˆ˜ì •"
        echo "3. UNKNOWN íƒ€ì… â†’ íŒŒì¼ëª… ê¸°ë°˜ íƒ€ì… ê°ì§€"
        echo "4. HTML íƒ€ì… â†’ ì‹¤ì œ íƒ€ì…ìœ¼ë¡œ ë³€í™˜"
        echo "5. ê¹¨ì§„ íŒŒì¼ëª… ì¸ì½”ë”© ë³µêµ¬"
        echo ""
        echo "ë‹¤ìŒ ë‹¨ê³„:"
        echo "- ì²¨ë¶€íŒŒì¼ íŒŒì‹± ì‹œìŠ¤í…œ êµ¬ì¶•"
        echo "- PDF/DOCX ìš°ì„  ì²˜ë¦¬"
        echo "- ë²¡í„° DB í†µí•©"
