name: ğŸ” Validate Attachment Accuracy (100% Target)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ê²€ì¦ ëŒ€ìƒ'
        required: true
        default: 'both'
        type: choice
        options:
        - both       # K-Startup + BizInfo
        - kstartup   # K-Startupë§Œ
        - bizinfo    # BizInfoë§Œ
      fix_mode:
        description: 'ìˆ˜ì • ëª¨ë“œ'
        required: true
        default: 'check'
        type: choice
        options:
        - check      # ê²€ì¦ë§Œ
        - fix        # ìë™ ìˆ˜ì • (100% ì •í™•ë„ ë‹¬ì„±)
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)

jobs:
  validate:
    name: ì²¨ë¶€íŒŒì¼ ì •í™•ë„ ê²€ì¦ (100% ëª©í‘œ)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 supabase python-dotenv
      
      - name: Validate Attachments with 100% Accuracy Check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TARGET: ${{ github.event.inputs.target || 'both' }}
          FIX_MODE: ${{ github.event.inputs.fix_mode || 'check' }}
        run: |
          echo "======================================"
          echo "  ğŸ¯ 100% ì •í™•ë„ ëª©í‘œ ê²€ì¦"
          echo "======================================"
          echo "ğŸ“Š ë‹¤ì¸µ ê°ì§€: íŒŒì¼ëª… â†’ URL íŒ¨í„´ â†’ Content-Type â†’ íŒŒì¼ ì‹œê·¸ë‹ˆì²˜"
          echo "ğŸ” ê²€ì¦ ëŒ€ìƒ: ${TARGET}"
          echo "ğŸ”§ ìˆ˜ì • ëª¨ë“œ: ${FIX_MODE}"
          
          # 100% ì •í™•ë„ ë‹¬ì„±ì„ ìœ„í•œ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "scripts/verify_attachment_collection.py" ]; then
            python scripts/verify_attachment_collection.py
          else
            echo "âš ï¸ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ê¸°ë³¸ ê²€ì¦ ì‹¤í–‰"
            python scripts/validate_attachments.py
          fi
          
          # ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ìë™ ìˆ˜ì • ì‹¤í–‰
          if [ "${FIX_MODE}" = "fix" ]; then
            echo ""
            echo "ğŸ”§ FILE íƒ€ì… ìë™ ìˆ˜ì • ì‹œì‘..."
            if [ -f "scripts/fix_remaining_file_types_final.py" ]; then
              python scripts/fix_remaining_file_types_final.py
            else
              echo "âš ï¸ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
            fi
          fi
