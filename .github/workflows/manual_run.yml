name: Bizinfo Manual Run

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install dependencies
      run: |
        pip install selenium webdriver-manager pandas openpyxl
        pip install requests beautifulsoup4 supabase
    
    - name: Run Bizinfo Collector
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "Starting Bizinfo collection..."
        python scripts/bizinfo_excel_collector.py
    
    - name: Run Bizinfo Processor
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "Processing attachments..."
        python scripts/bizinfo_complete_processor.py
    
    - name: Generate Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== Ï≤òÎ¶¨ Í≤∞Í≥º Î≥¥Í≥†ÏÑú ==="
        python -c "
import os
from supabase import create_client
from datetime import datetime

url = os.environ.get('SUPABASE_URL')
key = os.environ.get('SUPABASE_SERVICE_KEY')

if url and key:
    supabase = create_client(url, key)
    
    # Ïò§Îäò Îç∞Ïù¥ÌÑ∞
    today = datetime.now().date().isoformat()
    today_data = supabase.table('bizinfo_complete').select('id').gte('created_at', today).execute()
    
    # Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞
    total_data = supabase.table('bizinfo_complete').select('id').execute()
    
    print(f'üìä Í∏∞ÏóÖÎßàÎãπ Ï≤òÎ¶¨ Í≤∞Í≥º')
    print(f'Ï†ÑÏ≤¥: {len(total_data.data)}Í∞ú')
    print(f'Ïò§Îäò Ïã†Í∑ú: {len(today_data.data)}Í∞ú')
else:
    print('ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï Ïò§Î•ò')
"
