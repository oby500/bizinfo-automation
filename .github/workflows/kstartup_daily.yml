name: K-Startup Daily Collection

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'  # ë§¤ì¼ ì˜¤ì „ 7ì‹œ (KST = UTC+9)

jobs:
  daily_collect:
    name: K-Startup ì¼ì¼ ìˆ˜ì§‘
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase python-dotenv lxml
    
    - name: Daily Collection (ìµœê·¼ 200ê°œ í™•ì¸)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸš€ K-Startup ì¼ì¼ ìˆ˜ì§‘ ì‹œì‘..."
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/collect_kstartup_daily.py
    
    - name: Parse New Announcements
      if: success()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“ ì‹ ê·œ ê³µê³  ìƒì„¸ íŒŒì‹±..."
        python scripts/kstartup_parallel_parser.py
      continue-on-error: true
    
    - name: Process Attachments
      if: success()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“ ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬..."
        python scripts/kstartup_attachment_fix.py
      continue-on-error: true
    
    - name: Summary Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“Š ì¼ì¼ ìˆ˜ì§‘ ê²°ê³¼ ìš”ì•½"
        python -c "
        import os
        from supabase import create_client
        from datetime import datetime, timedelta
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_KEY')
        supabase = create_client(url, key)
        
        # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
        today = datetime.now().date().isoformat()
        result = supabase.table('kstartup_complete').select('biz_pbanc_nm, status, recept_end_dt').gte('created_at', today).execute()
        
        if result.data:
            print(f'âœ… ì˜¤ëŠ˜ ì¶”ê°€ëœ ê³µê³ : {len(result.data)}ê°œ')
            for item in result.data[:5]:
                print(f\"  - [{item['status']}] {item['biz_pbanc_nm'][:50]}\")
        else:
            print('ì˜¤ëŠ˜ ì¶”ê°€ëœ ê³µê³  ì—†ìŒ')
        
        # ì „ì²´ í†µê³„
        total = supabase.table('kstartup_complete').select('id').execute()
        print(f'\\nğŸ’¾ DB ì „ì²´: {len(total.data)}ê°œ')
        "