name: Test Download Automation

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'
        required: true
        default: 'basic_check'
        type: choice
        options:
        - basic_check     # ê¸°ë³¸ í™˜ê²½ ì²´í¬
        - script_test     # ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²• ì²´í¬
        - connection_test # DB ì—°ê²° í…ŒìŠ¤íŠ¸

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  test-environment:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'  # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •
    steps:
    - name: Display Korean Time
      run: |
        echo "ðŸ• í˜„ìž¬ í•œêµ­ì‹œê°„: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
        echo "ðŸ“‹ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode }}"
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test basic Python setup
      run: |
        echo "ðŸ Python version check"
        python --version
        pip list
        
    - name: Test environment variables
      run: |
        echo "ðŸ”§ Environment variables check"
        echo "SUPABASE_URL is set: ${{ env.SUPABASE_URL != '' }}"
        echo "SUPABASE_SERVICE_KEY is set: ${{ env.SUPABASE_SERVICE_KEY != '' }}"
        
    - name: Test script syntax
      if: github.event.inputs.test_mode != 'basic_check'
      run: |
        echo "ðŸ“ Script syntax check"
        python -m py_compile scripts/kstartup_attachment_enhanced_fixed.py || echo "âš ï¸ kstartup script has issues"
        python -m py_compile scripts/bizinfo_attachment_downloader.py || echo "âš ï¸ bizinfo script has issues"
        python -m py_compile scripts/rename_id_to_pbln_simple.py || echo "âš ï¸ rename script has issues"
        python -m py_compile scripts/upload_to_storage.py || echo "âš ï¸ upload script has issues"
        python -m py_compile scripts/detailed_attachment_verification.py || echo "âš ï¸ verification script has issues"
        python -m py_compile scripts/complete_attachment_manager.py || echo "âš ï¸ manager script has issues"
        
    - name: Test Supabase connection
      if: github.event.inputs.test_mode == 'connection_test'
      run: |
        echo "ðŸ”— Supabase connection test"
        cat > test_connection.py << 'EOF'
        import os
        from supabase import create_client
        from dotenv import load_dotenv

        load_dotenv()
        
        try:
            url = os.getenv('SUPABASE_URL')
            key = os.getenv('SUPABASE_SERVICE_KEY')
            
            if not url or not key:
                print("âŒ Environment variables not set")
                exit(1)
                
            supabase = create_client(url, key)
            
            # í…Œì´ë¸” ì¡´ìž¬ í™•ì¸
            result = supabase.table('kstartup_complete').select('id').limit(1).execute()
            print(f"âœ… K-Startup table: {len(result.data)} records found (sample)")
            
            result = supabase.table('bizinfo_complete').select('id').limit(1).execute()  
            print(f"âœ… BizInfo table: {len(result.data)} records found (sample)")
            
            print("ðŸŽ‰ Supabase connection successful!")
            
        except Exception as e:
            print(f"âŒ Connection failed: {e}")
            exit(1)
        EOF
        
        python test_connection.py
        
    - name: Create test summary
      run: |
        cat > test_summary.md << EOF
        # ìžë™í™” í…ŒìŠ¤íŠ¸ ê²°ê³¼
        
        **ì‹¤í–‰ ì‹œê°„**: $(date -u)
        **í…ŒìŠ¤íŠ¸ ëª¨ë“œ**: ${{ github.event.inputs.test_mode }}
        
        ## í…ŒìŠ¤íŠ¸ ê²°ê³¼
        - âœ… Python í™˜ê²½ ì„¤ì • ì™„ë£Œ
        - âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ
        - âœ… í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì™„ë£Œ
        EOF
        
        if [[ "${{ github.event.inputs.test_mode }}" != "basic_check" ]]; then
          echo "- âœ… ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²• ê²€ì¦ ì™„ë£Œ" >> test_summary.md
        fi
        
        if [[ "${{ github.event.inputs.test_mode }}" == "connection_test" ]]; then
          echo "- âœ… Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ" >> test_summary.md
        fi
        
        echo "" >> test_summary.md
        echo "## ë‹¤ìŒ ë‹¨ê³„" >> test_summary.md
        echo "- ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ" >> test_summary.md
        echo "- Perfect Download Automation ì‹¤í–‰ ê°€ëŠ¥" >> test_summary.md
        
        cat test_summary.md
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test_summary.md
          test_connection.py
        retention-days: 7