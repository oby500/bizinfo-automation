name: K-Startup Auto Collection

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * 0-4'  # í‰ì¼ ì˜¤ì „ 7ì‹œ (KST)

jobs:
  collect:
    name: K-Startup ìë™ ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase
    
    - name: Run K-Startup Collection
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "Starting K-Startup collection..."
        python scripts/kstartup_collector.py
    
    - name: Run processor (Fixed Version - íŒŒì¼ëª… ê°œì„ )
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "Processing attachments with improved filename extraction..."
        python scripts/kstartup_complete_processor_fixed.py
    
    - name: Generate Final Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime, timedelta
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY') or os.environ.get('SUPABASE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜: SUPABASE_URL ë˜ëŠ” SUPABASE_SERVICE_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            exit(1)
            
        supabase = create_client(url, key)
        
        try:
            # ì „ì²´ í†µê³„
            total = supabase.table('kstartup_complete').select('id').execute()
            total_count = len(total.data) if total.data else 0
            
            # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
            today = datetime.now().date().isoformat()
            today_new = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
            today_count = len(today_new.data) if today_new.data else 0
            
            # ì˜¤ëŠ˜ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°  
            today_updated = supabase.table('kstartup_complete').select('id').gte('updated_at', today).execute()
            updated_count = len(today_updated.data) if today_updated.data else 0
            
            # ì²¨ë¶€íŒŒì¼ ë³´ìœ  ë°ì´í„°
            with_attach = supabase.table('kstartup_complete').select('id').neq('attachment_urls', '[]').execute()
            attach_count = len(with_attach.data) if with_attach.data else 0
            
            # ìš”ì•½ ì²˜ë¦¬ëœ ë°ì´í„°
            with_summary = supabase.table('kstartup_complete').select('id').not_.is_('bsns_sumry', 'null').execute()
            summary_count = len(with_summary.data) if with_summary.data else 0
            
            # unknown í™•ì¥ì ê°œìˆ˜
            all_attachments = supabase.table('kstartup_complete').select('attachment_urls').neq('attachment_urls', '[]').execute()
            unknown_count = 0
            proper_count = 0
            if all_attachments.data:
                for item in all_attachments.data:
                    if item.get('attachment_urls'):
                        for att in item['attachment_urls']:
                            if att.get('safe_filename', '').endswith('.unknown'):
                                unknown_count += 1
                            else:
                                proper_count += 1
            
            # ìµœê·¼ ì²˜ë¦¬ ë°ì´í„° 5ê°œ
            recent = supabase.table('kstartup_complete').select(
                'biz_pbanc_nm', 'pbanc_ntrp_nm', 'attachment_count', 'created_at'
            ).order('created_at', desc=True).limit(5).execute()
            
            print('\n' + '='*50)
            print('      K-STARTUP ì²˜ë¦¬ ê²°ê³¼ ë³´ê³ ì„œ')
            print('='*50)
            print('\nğŸ“Š ì „ì²´ í†µê³„')
            print('â”' * 40)
            print(f'ì „ì²´ ë°ì´í„°: {total_count}ê°œ')
            print(f'ì˜¤ëŠ˜ ì‹ ê·œ ì¶”ê°€: {today_count}ê°œ')
            print(f'ì˜¤ëŠ˜ ì—…ë°ì´íŠ¸: {updated_count}ê°œ')
            print(f'ì²¨ë¶€íŒŒì¼ ë³´ìœ : {attach_count}ê°œ')
            print(f'ìš”ì•½ ì²˜ë¦¬ ì™„ë£Œ: {summary_count}ê°œ')
            
            print('\nğŸ“ ì²¨ë¶€íŒŒì¼ í’ˆì§ˆ')
            print('â”' * 40)
            print(f'ì •ìƒ íŒŒì¼ëª…: {proper_count}ê°œ')
            print(f'Unknown í™•ì¥ì: {unknown_count}ê°œ')
            if unknown_count > 0:
                print(f'âš ï¸ íŒŒì¼ëª… ê°œì„  í•„ìš”: {unknown_count}ê°œ')
            
            if today_count > 0 or updated_count > 0:
                print('\nâœ… ì˜¤ëŠ˜ ì²˜ë¦¬ ì„±ê³µ!')
            else:
                print('\nâš ï¸ ì˜¤ëŠ˜ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')
            
            print('\nğŸ“ ìµœê·¼ ì¶”ê°€ ë°ì´í„° (ìƒìœ„ 5ê°œ)')
            print('â”' * 40)
            if recent.data:
                for item in recent.data[:5]:
                    print(f"â€¢ {item['biz_pbanc_nm'][:40]}...")
                    if item.get('pbanc_ntrp_nm'):
                        print(f"  ì£¼ê´€: {item['pbanc_ntrp_nm']}")
                    print(f"  ì²¨ë¶€: {item.get('attachment_count', 0)}ê°œ | ë“±ë¡: {item['created_at'][:10]}")
                    print()
            else:
                print("ìµœê·¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            
            print('â”' * 40)
            print(f'ì²˜ë¦¬ ì™„ë£Œ ì‹œê°„: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
            print('='*50)
            
        except Exception as e:
            print(f"ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            exit(1)
        EOF
        python report.py
