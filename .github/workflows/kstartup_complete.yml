name: K-Startup Auto Collection

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * 0-4'  # í‰ì¼ ì˜¤ì „ 7ì‹œ (KST)

jobs:
  collect:
    name: K-Startup ìë™ ì²˜ë¦¬ (3ë‹¨ê³„)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase python-dotenv lxml
    
    # Step 1: ë°°ì¹˜ ìˆ˜ì§‘ (ì „ì²´ 259í˜ì´ì§€ í™•ì¸)
    - name: Step 1 - Batch Collection
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸš€ Step 1: K-Startup ë°°ì¹˜ ìˆ˜ì§‘ ì‹œì‘..."
        python scripts/collect_kstartup_batch.py
      continue-on-error: true
    
    # Step 2: bsns_sumry ë³‘ë ¬ íŒŒì‹± (ìƒì„¸ ë‚´ìš©)
    - name: Step 2 - Parallel Parsing
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“ Step 2: ìƒì„¸ ë‚´ìš© ë³‘ë ¬ íŒŒì‹±..."
        python scripts/kstartup_parallel_parser.py
      continue-on-error: true
    
    # Step 3: ì²¨ë¶€íŒŒì¼ ì •ë³´ ì²˜ë¦¬
    - name: Step 3 - Attachment Processing
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ“ Step 3: ì²¨ë¶€íŒŒì¼ ì •ë³´ ì²˜ë¦¬..."
        python scripts/kstartup_attachment_fix.py
      continue-on-error: true
    
    - name: Generate Final Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY') or os.environ.get('SUPABASE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜")
            exit(1)
            
        supabase = create_client(url, key)
        
        try:
            # ì „ì²´ í†µê³„
            total = supabase.table('kstartup_complete').select('id').execute()
            total_count = len(total.data) if total.data else 0
            
            # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
            today = datetime.now().date().isoformat()
            today_new = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
            today_count = len(today_new.data) if today_new.data else 0
            
            # ìƒíƒœë³„ í†µê³„
            status_data = supabase.table('kstartup_complete').select('status').execute()
            status_counts = {}
            if status_data.data:
                for item in status_data.data:
                    status = item.get('status', 'ìƒíƒœë¯¸ì •')
                    status_counts[status] = status_counts.get(status, 0) + 1
            
            # ì²¨ë¶€íŒŒì¼ í†µê³„
            with_attach = supabase.table('kstartup_complete').select('id').neq('attachment_urls', '[]').execute()
            attach_count = len(with_attach.data) if with_attach.data else 0
            
            # bsns_sumry í†µê³„
            with_sumry = supabase.table('kstartup_complete').select('id').neq('bsns_sumry', None).execute()
            sumry_count = len(with_sumry.data) if with_sumry.data else 0
            
            # unknown í™•ì¥ì ì²´í¬
            all_attachments = supabase.table('kstartup_complete').select('attachment_urls').neq('attachment_urls', '[]').execute()
            unknown_count = 0
            proper_count = 0
            if all_attachments.data:
                for item in all_attachments.data:
                    if item.get('attachment_urls'):
                        for att in item['attachment_urls']:
                            if isinstance(att, dict):
                                filename = att.get('safe_filename', '')
                                if filename.endswith('.unknown'):
                                    unknown_count += 1
                                else:
                                    proper_count += 1
            
            print('\n' + '='*60)
            print('      K-STARTUP 3ë‹¨ê³„ ì²˜ë¦¬ ê²°ê³¼')
            print('='*60)
            print(f'ğŸ“Š ì „ì²´: {total_count}ê°œ | ì˜¤ëŠ˜ ì‹ ê·œ/ì—…ë°ì´íŠ¸: {today_count}ê°œ')
            print('')
            print('ğŸ“ˆ ìƒíƒœë³„ ë¶„í¬:')
            for status, count in sorted(status_counts.items(), key=lambda x: x[1], reverse=True):
                print(f'   - {status}: {count}ê°œ')
            print('')
            print(f'ğŸ“ ìƒì„¸ë‚´ìš©(bsns_sumry): {sumry_count}ê°œ ({sumry_count/total_count*100:.1f}%)')
            print(f'ğŸ“ ì²¨ë¶€íŒŒì¼: {attach_count}ê°œ ({attach_count/total_count*100:.1f}%)')
            print(f'   âœ… ì •ìƒ: {proper_count}ê°œ | âš ï¸ Unknown: {unknown_count}ê°œ')
            
            if unknown_count == 0:
                print('\nâœ… ëª¨ë“  ì²¨ë¶€íŒŒì¼ ì •ìƒ ì²˜ë¦¬!')
            else:
                print(f'\nâš ï¸ Unknown íŒŒì¼ {unknown_count}ê°œ ì¬ì²˜ë¦¬ í•„ìš”')
            
            print('='*60)
            print('âœ… 3ë‹¨ê³„ ì²˜ë¦¬ ì™„ë£Œ: ë°°ì¹˜ìˆ˜ì§‘ â†’ ë³‘ë ¬íŒŒì‹± â†’ ì²¨ë¶€íŒŒì¼')
            
        except Exception as e:
            print(f"ë³´ê³ ì„œ ì˜¤ë¥˜: {e}")
        EOF
        python report.py
