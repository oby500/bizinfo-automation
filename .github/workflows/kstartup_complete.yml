name: K-Startup Auto Collection

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'ìˆ˜ì§‘ ëª¨ë“œ'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily    # ìµœê·¼ 200ê°œë§Œ (2-3ì´ˆ)
        - full     # ì „ì²´ 259í˜ì´ì§€ (30-60ì´ˆ)
  schedule:
    - cron: '0 22 * * *'  # ë§¤ì¼ ì˜¤ì „ 7ì‹œ (KST)

jobs:
  collect:
    name: K-Startup ìë™ ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase python-dotenv lxml
    
    - name: Determine Mode
      id: mode
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "mode=daily" >> $GITHUB_OUTPUT
          echo "ğŸ“… ìŠ¤ì¼€ì¤„ ì‹¤í–‰: daily ëª¨ë“œ"
        else
          echo "mode=${{ github.event.inputs.mode || 'daily' }}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.mode || 'daily' }} ëª¨ë“œ"
        fi
    
    - name: Create .env file
      run: |
        # ê°œë°œ í™˜ê²½ ì‚¬ìš© (í˜„ì¬ ì‚¬ìš© ì¤‘)
        echo "SUPABASE_URL=https://csuziaogycciwgxxmahm.supabase.co" >> .env
        echo "SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzdXppYW9neWNjaXdneHhtYWhtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzYxNTc4MCwiZXhwIjoyMDY5MTkxNzgwfQ.HnhM7zSLzi7lHVPd2IVQKIACDq_YA05mBMgZbSN1c9Q" >> .env
        echo "COLLECTION_MODE=${{ steps.mode.outputs.mode }}" >> .env

    # Step 1: ì‹¤ì œ K-Startup ë°ì´í„° ìˆ˜ì§‘ (API í˜•ì‹ ë³€ê²½ ëŒ€ì‘)
    - name: Collect K-Startup Data
      run: |
        echo "ğŸš€ K-Startup ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ (API í˜•ì‹ ë³€ê²½ ëŒ€ì‘)..."
        echo "ğŸ“… ëª¨ë“œ: ${{ steps.mode.outputs.mode }}"
        echo "ğŸ“Š Daily ëª¨ë“œ: ìµœê·¼ 200ê°œ í™•ì¸"
        echo "ğŸ“Š Full ëª¨ë“œ: ì „ì²´ ë°ì´í„° ìˆ˜ì§‘"
        python scripts/kstartup_daily_collector.py
      continue-on-error: true
    
    # Step 2: ìˆ˜ì§‘ ê²°ê³¼ í™•ì¸
    - name: Verify collection results
      run: |
        echo "ğŸ“Š ìˆ˜ì§‘ ê²°ê³¼ í™•ì¸..."
        python -c "
        from supabase import create_client
        import os
        from datetime import datetime
        from dotenv import load_dotenv
        
        load_dotenv()
        url = os.getenv('SUPABASE_URL')
        key = os.getenv('SUPABASE_KEY')
        supabase = create_client(url, key)
        
        # ì „ì²´ ê°œìˆ˜ í™•ì¸
        result = supabase.table('kstartup_complete').select('announcement_id').execute()
        total = len(result.data) if result.data else 0
        
        # ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ ê°œìˆ˜
        today = datetime.now().strftime('%Y-%m-%d')
        today_result = supabase.table('kstartup_complete').select('announcement_id').gte('created_at', today).execute()
        today_count = len(today_result.data) if today_result.data else 0
        
        # ìƒíƒœë³„ ê°œìˆ˜
        status_result = supabase.table('kstartup_complete').select('status').execute()
        status_counts = {}
        if status_result.data:
            for item in status_result.data:
                status = item.get('status', 'ìƒíƒœë¯¸ì •')
                status_counts[status] = status_counts.get(status, 0) + 1
        
        print('='*60)
        print('ğŸ“Š K-Startup ìˆ˜ì§‘ ì™„ë£Œ ë³´ê³ ì„œ (ê°œì„ ëœ ë¡œì§)')
        print('='*60)
        print(f'ì´ ì €ì¥ëœ ê³µê³ : {total}ê°œ')
        print(f'ì˜¤ëŠ˜ ìˆ˜ì§‘/ì—…ë°ì´íŠ¸: {today_count}ê°œ')
        print('')
        print('ìƒíƒœë³„ ë¶„í¬:')
        for status, count in sorted(status_counts.items(), key=lambda x: x[1], reverse=True):
            print(f'  - {status}: {count}ê°œ')
        print('='*60)
        print('ğŸ“Œ ê°œì„  ì‚¬í•­:')
        print('  - perPage=200 (êµ¬ê¸€ì‹œíŠ¸ì™€ ë™ì¼)')
        print('  - ì—°ì† 50ê°œ ì¤‘ë³µ ì‹œ ìë™ ì¢…ë£Œ')
        print('  - í˜ì´ì§€ ë‹¨ìœ„ ì¤‘ë³µ ì²´í¬')
        print('='*60)
        "
    
    # Step 3: bsns_sumry ë³‘ë ¬ íŒŒì‹± (ì„ íƒì )
    - name: Step 3 - Parallel Parsing (Optional)
      if: steps.mode.outputs.mode == 'full'
      run: |
        echo "ğŸ“ Step 3: ìƒì„¸ ë‚´ìš© ë³‘ë ¬ íŒŒì‹±..."
        python scripts/kstartup_parallel_parser.py || echo "íŒŒì‹± ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ê±´ë„ˆë›°ê¸°"
          
    # Step 4: K-Startup ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬
    - name: Step 4 - K-Startup Attachment Processing
      if: steps.mode.outputs.mode == 'full'
      run: |
        echo "ğŸ“ Step 4: K-Startup ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬..."
        python scripts/kstartup_attachment_processor.py || echo "ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨ - ê±´ë„ˆë›°ê¸°"
          
    - name: Generate Final Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY') or os.environ.get('SUPABASE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜")
            exit(1)
            
        supabase = create_client(url, key)
        
        try:
            # ì „ì²´ í†µê³„
            total = supabase.table('kstartup_complete').select('id').execute()
            total_count = len(total.data) if total.data else 0
            
            # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
            today = datetime.now().date().isoformat()
            today_new = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
            today_count = len(today_new.data) if today_new.data else 0
            
            # ìƒíƒœë³„ í†µê³„
            status_data = supabase.table('kstartup_complete').select('status').execute()
            status_counts = {}
            if status_data.data:
                for item in status_data.data:
                    status = item.get('status', 'ìƒíƒœë¯¸ì •')
                    status_counts[status] = status_counts.get(status, 0) + 1
            
            print('\n' + '='*60)
            print('      K-STARTUP ì²˜ë¦¬ ê²°ê³¼')
            print('='*60)
            print(f'ğŸ“Š ì „ì²´: {total_count}ê°œ | ì˜¤ëŠ˜ ì‹ ê·œ/ì—…ë°ì´íŠ¸: {today_count}ê°œ')
            print('')
            print('ğŸ“ˆ ìƒíƒœë³„ ë¶„í¬:')
            for status, count in sorted(status_counts.items(), key=lambda x: x[1], reverse=True):
                print(f'   - {status}: {count}ê°œ')
            print('='*60)
            
        except Exception as e:
            print(f"ë³´ê³ ì„œ ì˜¤ë¥˜: {e}")
        EOF
        python report.py
