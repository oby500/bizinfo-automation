name: K-Startup Auto Collection

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì‹¤í–‰ (UTC 00:00 = KST 09:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  collect-kstartup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        pip install supabase
        pip install python-dotenv
        pip install beautifulsoup4
        pip install lxml
    
    - name: Create .env file
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
    
    # Step 1: ê¸°ë³¸ ë°ì´í„° ìˆ˜ì§‘ (ë°°ì¹˜ ì²˜ë¦¬)
    - name: Collect K-Startup data (Batch)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "ğŸš€ K-Startup ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."
        python collect_kstartup_batch.py
      continue-on-error: true
    
    # Step 2: bsns_sumry ë³‘ë ¬ íŒŒì‹± (ìƒì„¸ ë‚´ìš© í¬ë¡¤ë§)
    - name: Parse business summaries in parallel
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "ğŸ“ ìƒì„¸ ë‚´ìš© íŒŒì‹± ì‹œì‘..."
        python kstartup_parallel_parser.py
      continue-on-error: true
    
    # Step 3: ì²¨ë¶€íŒŒì¼ ì •ë³´ ì²˜ë¦¬
    - name: Process attachment information
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "ğŸ“ ì²¨ë¶€íŒŒì¼ ì •ë³´ ì²˜ë¦¬..."
        python kstartup_attachment_fix.py
      continue-on-error: true
    
    # Step 4: ìˆ˜ì§‘ ê²°ê³¼ í™•ì¸
    - name: Verify collection results
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "ğŸ“Š ìˆ˜ì§‘ ê²°ê³¼ í™•ì¸..."
        python -c "
        from supabase import create_client
        import os
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_KEY')
        supabase = create_client(url, key)
        
        # ì „ì²´ ê°œìˆ˜ í™•ì¸
        result = supabase.table('kstartup_complete').select('announcement_id').execute()
        total = len(result.data) if result.data else 0
        
        # ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ ê°œìˆ˜
        today = datetime.now().strftime('%Y-%m-%d')
        today_result = supabase.table('kstartup_complete').select('announcement_id').gte('created_at', today).execute()
        today_count = len(today_result.data) if today_result.data else 0
        
        # ìƒíƒœë³„ ê°œìˆ˜
        status_result = supabase.table('kstartup_complete').select('status').execute()
        status_counts = {}
        if status_result.data:
            for item in status_result.data:
                status = item.get('status', 'ìƒíƒœë¯¸ì •')
                status_counts[status] = status_counts.get(status, 0) + 1
        
        print('='*60)
        print('ğŸ“Š K-Startup ìˆ˜ì§‘ ì™„ë£Œ ë³´ê³ ì„œ')
        print('='*60)
        print(f'ì´ ì €ì¥ëœ ê³µê³ : {total}ê°œ')
        print(f'ì˜¤ëŠ˜ ìˆ˜ì§‘/ì—…ë°ì´íŠ¸: {today_count}ê°œ')
        print('')
        print('ìƒíƒœë³„ ë¶„í¬:')
        for status, count in sorted(status_counts.items(), key=lambda x: x[1], reverse=True):
            print(f'  - {status}: {count}ê°œ')
        print('='*60)
        "
    
    # Step 5: ì‹¤í–‰ ì™„ë£Œ ì•Œë¦¼
    - name: Send completion notification
      if: always()
      run: |
        echo "âœ… K-Startup ìë™ ìˆ˜ì§‘ ì™„ë£Œ"
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ë°°ì¹˜ ì²˜ë¦¬ + ë³‘ë ¬ íŒŒì‹± + ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ"
