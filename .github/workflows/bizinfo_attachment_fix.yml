name: ğŸ”§ BizInfo Attachment Fix (K-Startup Style)

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì²˜ìŒ 10ê°œë§Œ ì²˜ë¦¬)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  fix-attachments:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 supabase python-dotenv
    
    - name: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "SUPABASE_URL=$SUPABASE_URL" >> .env
        echo "SUPABASE_KEY=$SUPABASE_KEY" >> .env
    
    - name: í…ŒìŠ¤íŠ¸ ëª¨ë“œ ìˆ˜ì • (í•„ìš”ì‹œ)
      if: ${{ github.event.inputs.test_mode == 'true' }}
      run: |
        # í…ŒìŠ¤íŠ¸ ëª¨ë“œì¼ ë•Œ ì²˜ìŒ 10ê°œë§Œ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •
        sed -i 's/.execute()/.limit(10).execute()/' scripts/bizinfo_attachment_fix_kstartup_style.py
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì²˜ìŒ 10ê°œ ê³µê³ ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤."
    
    - name: ğŸš€ ì²¨ë¶€íŒŒì¼ ì •ë³´ ìˆ˜ì • ì‹¤í–‰
      run: |
        echo "============================================================"
        echo " BizInfo ì²¨ë¶€íŒŒì¼ K-Startup ë°©ì‹ ì ìš©"
        echo "============================================================"
        echo "ëª¨ë“œ: ${{ github.event.inputs.test_mode == 'true' && 'í…ŒìŠ¤íŠ¸ (10ê°œ)' || 'ì „ì²´ ì²˜ë¦¬' }}"
        echo ""
        python scripts/bizinfo_attachment_fix_kstartup_style.py
    
    - name: ğŸ“Š ê²°ê³¼ í™•ì¸
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        cat << 'EOF' > check_results.py
        import os
        from supabase import create_client
        from dotenv import load_dotenv
        
        load_dotenv()
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_KEY')
        supabase = create_client(url, key)
        
        # DOC íƒ€ì… ë‚¨ì€ ê°œìˆ˜
        result = supabase.table('bizinfo_complete')\
            .select('pblanc_id', count='exact')\
            .execute()
        
        total = result.count if hasattr(result, 'count') else 0
        
        # ìƒ˜í”Œ ë°ì´í„°
        sample = supabase.table('bizinfo_complete')\
            .select('pblanc_id, pblanc_nm, attachment_urls')\
            .eq('pblanc_id', 'PBLN_000000000113616')\
            .execute()
        
        print("\n" + "="*60)
        print(" ğŸ“Š ì²˜ë¦¬ ê²°ê³¼ í™•ì¸")
        print("="*60)
        
        if sample.data:
            for s in sample.data:
                print(f"\nê³µê³ : {s['pblanc_id']}")
                print(f"ì œëª©: {s['pblanc_nm'][:40]}...")
                for att in s.get('attachment_urls', []):
                    print(f"  - Type: {att.get('type')}")
                    print(f"    File: {att.get('display_filename')}")
        
        # í†µê³„
        doc_count = 0
        download_count = 0
        
        all_data = supabase.table('bizinfo_complete')\
            .select('attachment_urls')\
            .not_.is_('attachment_urls', 'null')\
            .execute()
        
        for row in all_data.data:
            if row.get('attachment_urls'):
                for att in row['attachment_urls']:
                    if att.get('type') == 'DOC':
                        doc_count += 1
                    if att.get('display_filename') == 'ë‹¤ìš´ë¡œë“œ':
                        download_count += 1
        
        print(f"\nğŸ“ˆ í†µê³„:")
        print(f"  - ë‚¨ì€ DOC íƒ€ì…: {doc_count}ê°œ")
        print(f"  - ë‚¨ì€ 'ë‹¤ìš´ë¡œë“œ' íŒŒì¼ëª…: {download_count}ê°œ")
        print("="*60)
        EOF
        
        python check_results.py
    
    - name: ë¡œê·¸ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: attachment-fix-logs
        path: |
          bizinfo_attachment_fix_*.log
        retention-days: 7
