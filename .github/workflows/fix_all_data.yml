name: Manual Fix All Data

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ì²˜ë¦¬ ëŒ€ìƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - bizinfo
          - kstartup
      limit:
        description: 'ì²˜ë¦¬ ê°œìˆ˜ ì œí•œ'
        required: false
        default: '500'
        type: string

jobs:
  fix-data:
    name: ì „ì²´ ë°ì´í„° ìˆ˜ì • ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase
    
    - name: Fix BizInfo Data
      if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'bizinfo' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== ê¸°ì—…ë§ˆë‹¹ ë°ì´í„° ìˆ˜ì • ì‹œì‘ ==="
        echo "ì²˜ë¦¬ ëŒ€ìƒ: safe_filename ì—†ëŠ” ë°ì´í„° + unknown í™•ì¥ì"
        python scripts/bizinfo_complete_processor_fast.py
    
    - name: Fix K-Startup Data
      if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'kstartup' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ë°ì´í„° ìˆ˜ì • ì‹œì‘ ==="
        echo "ì²˜ë¦¬ ëŒ€ìƒ: unknown í™•ì¥ì ëª¨ë‘ ì¬ì²˜ë¦¬"
        python scripts/kstartup_complete_processor_final.py
    
    - name: Generate Comprehensive Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        import json
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜")
            exit(1)
            
        supabase = create_client(url, key)
        
        print('\n' + '='*60)
        print('          ì „ì²´ ë°ì´í„° í’ˆì§ˆ ë³´ê³ ì„œ')
        print('='*60)
        
        # ê¸°ì—…ë§ˆë‹¹ í†µê³„
        print('\nğŸ“Š ê¸°ì—…ë§ˆë‹¹ (bizinfo_complete)')
        print('-' * 50)
        
        bizinfo_total = supabase.table('bizinfo_complete').select('id').execute()
        total_biz = len(bizinfo_total.data) if bizinfo_total.data else 0
        
        bizinfo_with_attach = supabase.table('bizinfo_complete').select('attachment_urls').neq('attachment_urls', '[]').execute()
        
        biz_with_safe = 0
        biz_without_safe = 0
        biz_unknown = 0
        
        if bizinfo_with_attach.data:
            for item in bizinfo_with_attach.data:
                if item.get('attachment_urls'):
                    attachments_str = json.dumps(item['attachment_urls'])
                    if 'safe_filename' in attachments_str:
                        biz_with_safe += 1
                        if '.unknown' in attachments_str:
                            biz_unknown += 1
                    else:
                        biz_without_safe += 1
        
        print(f'ì „ì²´: {total_biz}ê°œ')
        print(f'ì²¨ë¶€íŒŒì¼ ìˆìŒ: {len(bizinfo_with_attach.data) if bizinfo_with_attach.data else 0}ê°œ')
        print(f'â”œâ”€ safe_filename ìˆìŒ: {biz_with_safe}ê°œ')
        print(f'â”œâ”€ safe_filename ì—†ìŒ: {biz_without_safe}ê°œ âš ï¸')
        print(f'â””â”€ unknown í™•ì¥ì: {biz_unknown}ê°œ âš ï¸')
        
        # K-Startup í†µê³„
        print('\nğŸ“Š K-Startup (kstartup_complete)')
        print('-' * 50)
        
        kstartup_total = supabase.table('kstartup_complete').select('id').execute()
        total_k = len(kstartup_total.data) if kstartup_total.data else 0
        
        kstartup_with_attach = supabase.table('kstartup_complete').select('attachment_urls').neq('attachment_urls', '[]').execute()
        
        k_proper = 0
        k_unknown = 0
        k_no_attach = 0
        
        if kstartup_with_attach.data:
            for item in kstartup_with_attach.data:
                if item.get('attachment_urls'):
                    has_unknown = False
                    for att in item['attachment_urls']:
                        if att.get('safe_filename', '').endswith('.unknown'):
                            has_unknown = True
                            break
                    if has_unknown:
                        k_unknown += 1
                    else:
                        k_proper += 1
        
        k_no_attach = total_k - len(kstartup_with_attach.data) if kstartup_with_attach.data else total_k
        
        print(f'ì „ì²´: {total_k}ê°œ')
        print(f'â”œâ”€ ì²¨ë¶€íŒŒì¼ ì—†ìŒ: {k_no_attach}ê°œ')
        print(f'â”œâ”€ ì •ìƒ íŒŒì¼ëª…: {k_proper}ê°œ')
        print(f'â””â”€ unknown í™•ì¥ì: {k_unknown}ê°œ âš ï¸')
        
        # ì²˜ë¦¬ í•„ìš” í•­ëª©
        print('\nğŸ”§ ì²˜ë¦¬ í•„ìš” í•­ëª©')
        print('-' * 50)
        
        total_issues = biz_without_safe + biz_unknown + k_unknown
        
        if total_issues > 0:
            print(f'âš ï¸ ì´ {total_issues}ê°œ í•­ëª© ì²˜ë¦¬ í•„ìš”:')
            if biz_without_safe > 0:
                print(f'  - ê¸°ì—…ë§ˆë‹¹ safe_filename ì—†ìŒ: {biz_without_safe}ê°œ')
            if biz_unknown > 0:
                print(f'  - ê¸°ì—…ë§ˆë‹¹ unknown í™•ì¥ì: {biz_unknown}ê°œ')
            if k_unknown > 0:
                print(f'  - K-Startup unknown í™•ì¥ì: {k_unknown}ê°œ')
            print('\nğŸ’¡ ìˆ˜ë™ ì‹¤í–‰ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.')
        else:
            print('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒì…ë‹ˆë‹¤!')
        
        # ìµœê·¼ ì—…ë°ì´íŠ¸
        print('\nğŸ“… ìµœê·¼ ì—…ë°ì´íŠ¸')
        print('-' * 50)
        
        today = datetime.now().date().isoformat()
        
        biz_today = supabase.table('bizinfo_complete').select('id').gte('updt_dt', today).execute()
        k_today = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
        
        print(f'ì˜¤ëŠ˜ ì—…ë°ì´íŠ¸:')
        print(f'  - ê¸°ì—…ë§ˆë‹¹: {len(biz_today.data) if biz_today.data else 0}ê°œ')
        print(f'  - K-Startup: {len(k_today.data) if k_today.data else 0}ê°œ')
        
        print('\n' + '='*60)
        print(f'ë³´ê³ ì„œ ìƒì„±: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
        print('='*60)
        
        EOF
        python report.py
