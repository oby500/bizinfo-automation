name: Manual Fix K-Startup Data

on:
  workflow_dispatch:
    inputs:
      limit:
        description: 'ì²˜ë¦¬í•  ë°ì´í„° ê°œìˆ˜'
        required: false
        default: '100'
        type: string
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'enhance_quality'
        type: choice
        options:
          - enhance_quality
          - fix_unknown_ext
          - fix_poor_summary
          - fix_all

jobs:
  fix_data:
    name: K-Startup ë°ì´í„° ìˆ˜ì •
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase
    
    - name: Run Quality Enhancer
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ”§ K-Startup ë°ì´í„° í’ˆì§ˆ ê°œì„  ì‹œì‘"
        echo "ğŸ“Š ì²˜ë¦¬ ê°œìˆ˜: ${{ github.event.inputs.limit }}"
        echo "ğŸ¯ ì‘ì—… ìœ í˜•: ${{ github.event.inputs.action }}"
        
        python scripts/kstartup_quality_enhancer_fixed.py ${{ github.event.inputs.limit }}
    
    - name: Generate Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜")
            exit(1)
            
        supabase = create_client(url, key)
        
        # í†µê³„ ìˆ˜ì§‘
        total = supabase.table('kstartup_complete').select('id', count='exact').execute()
        
        # unknown í™•ì¥ì ê°œìˆ˜
        unknown = supabase.table('kstartup_complete')\
            .select('id', count='exact')\
            .like('attachment_urls', '%unknown%')\
            .execute()
        
        # í•´ì‹œíƒœê·¸ ìˆëŠ” ë°ì´í„°
        with_hashtag = supabase.table('kstartup_complete')\
            .select('id', count='exact')\
            .neq('hash_tag', '')\
            .execute()
        
        # ì²¨ë¶€íŒŒì¼ ìˆëŠ” ë°ì´í„°
        with_attach = supabase.table('kstartup_complete')\
            .select('id', count='exact')\
            .neq('attachment_urls', '[]')\
            .execute()
        
        # í’ˆì§ˆ ë‚®ì€ ìš”ì•½
        poor_summary = supabase.table('kstartup_complete')\
            .select('id', count='exact')\
            .or_('bsns_sumry.like.%ëª¨ì§‘ì¤‘%,bsns_sumry.like.%URLë³µì‚¬%')\
            .execute()
        
        print('\n' + '='*50)
        print('      K-STARTUP ë°ì´í„° í’ˆì§ˆ ë³´ê³ ì„œ')
        print('='*50)
        print('\nğŸ“Š ì „ì²´ í†µê³„')
        print('â”' * 40)
        print(f'ì „ì²´ ë°ì´í„°: {total.count}ê°œ')
        print(f'ì²¨ë¶€íŒŒì¼ ë³´ìœ : {with_attach.count}ê°œ ({with_attach.count/total.count*100:.1f}%)')
        print(f'í•´ì‹œíƒœê·¸ ë³´ìœ : {with_hashtag.count}ê°œ ({with_hashtag.count/total.count*100:.1f}%)')
        
        print('\nâš ï¸ í’ˆì§ˆ ë¬¸ì œ')
        print('â”' * 40)
        print(f'Unknown í™•ì¥ì: {unknown.count}ê°œ')
        print(f'í’ˆì§ˆ ë‚®ì€ ìš”ì•½: {poor_summary.count}ê°œ')
        
        if unknown.count == 0:
            print('\nâœ… ëª¨ë“  ì²¨ë¶€íŒŒì¼ í™•ì¥ìê°€ ì •ìƒì…ë‹ˆë‹¤!')
        else:
            print(f'\nğŸ”§ ì•„ì§ {unknown.count}ê°œì˜ unknown íŒŒì¼ì´ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.')
        
        print('\n' + '='*50)
        print(f'ë³´ê³ ì„œ ìƒì„±: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
        EOF
        
        python report.py
