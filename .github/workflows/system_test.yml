name: System Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'í…ŒìŠ¤íŠ¸ ìœ í˜•'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick      # ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ (í™˜ê²½ë³€ìˆ˜, API ì—°ê²°)
          - full       # ì „ì²´ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ìˆ˜ì§‘ ì‹œë„)

jobs:
  quick-test:
    name: Quick Test
    if: ${{ github.event.inputs.test_type == 'quick' }}
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase
    
    - name: Run System Test
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== ìë™í™” ì‹œìŠ¤í…œ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ==="
        python scripts/test_automation.py
    
    - name: Check Workflow Schedules
      run: |
        echo -e "\n=== ì›Œí¬í”Œë¡œìš° ìŠ¤ì¼€ì¤„ í™•ì¸ ==="
        echo "ğŸ“… ê¸°ì—…ë§ˆë‹¹: í‰ì¼ ì˜¤í›„ 5ì‹œ (KST) = UTC 8ì‹œ"
        echo "ğŸ“… K-Startup: í‰ì¼ ì˜¤ì „ 7ì‹œ (KST) = UTC 22ì‹œ"
        echo ""
        echo "í˜„ì¬ ì‹œê°„ (UTC): $(date -u)"
        echo "í˜„ì¬ ì‹œê°„ (KST): $(TZ=Asia/Seoul date)"

  full-test:
    name: Full Test
    if: ${{ github.event.inputs.test_type == 'full' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome (for Bizinfo)
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install dependencies
      run: |
        pip install selenium webdriver-manager pandas openpyxl
        pip install requests beautifulsoup4 supabase
    
    - name: Test K-Startup Collection (5 items only)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸ (5ê°œë§Œ) ==="
        python -c "
import os
import sys
sys.path.insert(0, 'scripts')
from kstartup_collector import KStartupCollector

# 5ê°œë§Œ ìˆ˜ì§‘í•˜ë„ë¡ ìˆ˜ì •
collector = KStartupCollector()
collector.max_items = 5  # í…ŒìŠ¤íŠ¸ìš© ì œí•œ
try:
    collector.run()
    print('âœ… K-Startup í…ŒìŠ¤íŠ¸ ì„±ê³µ')
except Exception as e:
    print(f'âŒ K-Startup í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
"
    
    - name: Show Results
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        python -c "
from supabase import create_client
import os
from datetime import datetime

url = os.environ.get('SUPABASE_URL')
key = os.environ.get('SUPABASE_SERVICE_KEY')
supabase = create_client(url, key)

# ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸
today = datetime.now().date().isoformat()

# K-Startup
k_today = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
print(f'ğŸ“Š K-Startup ì˜¤ëŠ˜ ì‹ ê·œ: {len(k_today.data)}ê°œ')

# ê¸°ì—…ë§ˆë‹¹
b_today = supabase.table('bizinfo_complete').select('id').gte('created_at', today).execute()
print(f'ğŸ“Š ê¸°ì—…ë§ˆë‹¹ ì˜¤ëŠ˜ ì‹ ê·œ: {len(b_today.data)}ê°œ')
"
