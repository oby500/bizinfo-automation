name: ğŸ”§ K-Startup ìˆ˜ë™ ì‹¤í–‰

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        required: true
        default: 'full_process'
        type: choice
        options:
          - full_process     # ìˆ˜ì§‘ + ì²˜ë¦¬ ì „ì²´
          - collect_only     # ìˆ˜ì§‘ë§Œ
          - attachment_only  # ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ë§Œ

jobs:
  manual-kstartup:
    name: K-Startup ìˆ˜ë™ ì²˜ë¦¬
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 supabase
    
    - name: Collect K-Startup Data
      if: ${{ github.event.inputs.action == 'collect_only' || github.event.inputs.action == 'full_process' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ë°ì´í„° ìˆ˜ì§‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/kstartup_collector.py
    
    - name: Process Attachments
      if: ${{ github.event.inputs.action == 'attachment_only' || github.event.inputs.action == 'full_process' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ ==="
        python scripts/kstartup_complete_processor.py
    
    - name: Show Results
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY') or os.environ.get('SUPABASE_KEY')
        
        if not url or not key:
            print("í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜")
            exit(1)
            
        supabase = create_client(url, key)
        
        # ì˜¤ëŠ˜ ì²˜ë¦¬ëœ ë°ì´í„°
        today = datetime.now().date().isoformat()
        today_data = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
        
        # ì²¨ë¶€íŒŒì¼ í˜„í™©
        with_attach = supabase.table('kstartup_complete').select('id').neq('attachment_urls', '[]').execute()
        
        print('=' * 50)
        print('   K-STARTUP ìˆ˜ë™ ì‹¤í–‰ ê²°ê³¼')
        print('=' * 50)
        print(f'ğŸ“Š ì˜¤ëŠ˜ ì²˜ë¦¬: {len(today_data.data)}ê°œ')
        print(f'ğŸ“ ì²¨ë¶€íŒŒì¼ ë³´ìœ : {len(with_attach.data)}ê°œ')
        print(f'â° ì™„ë£Œ ì‹œê°„: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
        print('=' * 50)
        EOF
        python report.py
