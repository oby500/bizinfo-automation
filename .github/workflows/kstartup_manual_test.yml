name: K-Startup Manual Test

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì „ìš©
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        required: true
        default: 'attachment_only'
        type: choice
        options:
          - attachment_only  # ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ë§Œ
          - collect_only     # ìˆ˜ì§‘ë§Œ
          - full_process     # ìˆ˜ì§‘ + ì²˜ë¦¬ ì „ì²´

jobs:
  test-kstartup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 supabase
    
    - name: Collect K-Startup Data
      if: ${{ github.event.inputs.action == 'collect_only' || github.event.inputs.action == 'full_process' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ë°ì´í„° ìˆ˜ì§‘ ==="
        python scripts/kstartup_collector.py
    
    - name: Process Attachments
      if: ${{ github.event.inputs.action == 'attachment_only' || github.event.inputs.action == 'full_process' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ ==="
        python scripts/kstartup_complete_processor.py
    
    - name: Show Results
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== ì²˜ë¦¬ ê²°ê³¼ í™•ì¸ ==="
        python -c "
import os
from supabase import create_client
from datetime import datetime, timedelta

url = os.environ.get('SUPABASE_URL')
key = os.environ.get('SUPABASE_KEY')
supabase = create_client(url, key)

# ìµœê·¼ ì²˜ë¦¬ëœ ë°ì´í„° 5ê°œ
recent = supabase.table('kstartup_complete').select(
    'biz_pbanc_nm', 'attachment_count', 'created_at', 'updated_at'
).order('updated_at', desc=True).limit(5).execute()

print('ìµœê·¼ ì²˜ë¦¬ëœ K-Startup ë°ì´í„°:')
print('=' * 50)
for item in recent.data:
    print(f\"ì œëª©: {item['biz_pbanc_nm'][:40]}...\")
    print(f\"ì²¨ë¶€íŒŒì¼: {item.get('attachment_count', 0)}ê°œ\")
    print(f\"ì—…ë°ì´íŠ¸: {item['updated_at']}\")
    print('-' * 50)

# í†µê³„
total = supabase.table('kstartup_complete').select('id').execute()
with_attach = supabase.table('kstartup_complete').select('id').neq('attachment_urls', '[]').execute()

print(f'\nğŸ“Š ì „ì²´ í†µê³„:')
print(f'ì „ì²´: {len(total.data)}ê°œ')
print(f'ì²¨ë¶€íŒŒì¼ ë³´ìœ : {len(with_attach.data)}ê°œ')"
