name: K-Startup Collection

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 7ì‹œ ì‹¤í–‰ (KST) = UTC 22:00 (ì „ë‚ )
    - cron: '0 22 * * 0-4'  # ì¼-ëª© UTC 22:00 = ì›”-ê¸ˆ KST 07:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  collect-kstartup:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4
        pip install supabase
    
    - name: Collect K-Startup Data
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/kstartup_collector.py
    
    - name: Process Attachments and Summary
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ì²¨ë¶€íŒŒì¼ ë° ìš”ì•½ ì²˜ë¦¬ ==="
        python -c "
import os
import sys
import time
import requests
from datetime import datetime
from bs4 import BeautifulSoup
from urllib.parse import urljoin
from supabase import create_client

url = os.environ.get('SUPABASE_URL')
key = os.environ.get('SUPABASE_KEY')
supabase = create_client(url, key)

# ì²˜ë¦¬ ëŒ€ìƒ ì¡°íšŒ
result = supabase.table('kstartup_complete').select(
    'id', 'announcement_id', 'biz_pbanc_nm', 'detl_pg_url',
    'pbanc_ntrp_nm', 'aply_trgt_ctnt', 'pbanc_rcpt_end_dt'
).or_(
    'attachment_urls.is.null',
    'bsns_sumry.is.null'
).limit(50).execute()

processed = 0
for item in result.data:
    try:
        # í•´ì‹œíƒœê·¸ ìƒì„±
        tags = []
        if item.get('pbanc_ntrp_nm'):
            tags.append(f\"#{item['pbanc_ntrp_nm'][:15]}\")
        if item.get('aply_trgt_ctnt'):
            if 'ìŠ¤íƒ€íŠ¸ì—…' in item['aply_trgt_ctnt']:
                tags.append('#ìŠ¤íƒ€íŠ¸ì—…')
            if 'ì²­ë…„' in item['aply_trgt_ctnt']:
                tags.append('#ì²­ë…„ì°½ì—…')
        
        # ìš”ì•½ ìƒì„±
        summary = f\"ğŸ“‹ {item['biz_pbanc_nm']}\\n\"
        if item.get('pbanc_ntrp_nm'):
            summary += f\"ğŸ¢ ì£¼ê´€: {item['pbanc_ntrp_nm']}\\n\"
        if item.get('pbanc_rcpt_end_dt'):
            summary += f\"ğŸ“… ë§ˆê°: {item['pbanc_rcpt_end_dt']}\\n\"
        if tags:
            summary += f\"ğŸ·ï¸ {' '.join(tags[:5])}\"
        
        # DB ì—…ë°ì´íŠ¸
        supabase.table('kstartup_complete').update({
            'bsns_sumry': summary,
            'hash_tags': ' '.join(tags),
            'updated_at': datetime.now().isoformat()
        }).eq('id', item['id']).execute()
        
        processed += 1
        print(f\"ì²˜ë¦¬: {item['biz_pbanc_nm'][:30]}...\")
        time.sleep(0.5)
        
    except Exception as e:
        print(f\"ì˜¤ë¥˜: {e}\")
        continue

print(f\"\\nâœ… ì²˜ë¦¬ ì™„ë£Œ: {processed}ê°œ\")"
    
    - name: Generate Summary Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ì²˜ë¦¬ ê²°ê³¼ ==="
        python -c "
import os
from supabase import create_client
from datetime import datetime

try:
    url = os.environ.get('SUPABASE_URL')
    key = os.environ.get('SUPABASE_KEY')
    supabase = create_client(url, key)
    
    # ì „ì²´ ë°ì´í„°
    total_result = supabase.table('kstartup_complete').select('id').execute()
    total_count = len(total_result.data) if total_result.data else 0
    
    # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
    today = datetime.now().date().isoformat()
    today_result = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
    today_count = len(today_result.data) if today_result.data else 0
    
    print(f'ğŸ“Š K-Startup ì²˜ë¦¬ í˜„í™©')
    print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    print(f'ì „ì²´ ë°ì´í„°: {total_count}ê°œ')
    print(f'ì˜¤ëŠ˜ ì¶”ê°€: {today_count}ê°œ')
    print(f'ì²˜ë¦¬ ì‹œê°„: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')'
except Exception as e:
    print(f'í†µê³„ ìƒì„± ì‹¤íŒ¨: {e}')"
