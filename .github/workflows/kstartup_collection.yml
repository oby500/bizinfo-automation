name: K-Startup Collection

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  schedule:
    # í‰ì¼ ì˜¤ì „ 7ì‹œ ì‹¤í–‰ (KST) = UTC 22:00 (ì „ë‚ )
    - cron: '0 22 * * 0-4'  # ì¼-ëª© UTC 22:00 = ì›”-ê¸ˆ KST 07:00

jobs:
  collect-kstartup:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4
        pip install supabase
    
    - name: Collect K-Startup Data
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/kstartup_collector.py
    
    - name: Process Attachments and Generate Summary
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ ë° ìš”ì•½ ìƒì„± ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/kstartup_complete_processor.py
    
    - name: Generate Summary Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ì²˜ë¦¬ ê²°ê³¼ ==="
        python -c "
import os
from supabase import create_client
from datetime import datetime

try:
    url = os.environ.get('SUPABASE_URL')
    key = os.environ.get('SUPABASE_KEY')
    supabase = create_client(url, key)
    
    # ì „ì²´ ë°ì´í„°
    total_result = supabase.table('kstartup_complete').select('id').execute()
    total_count = len(total_result.data) if total_result.data else 0
    
    # ì˜¤ëŠ˜ ì¶”ê°€ëœ ë°ì´í„°
    today = datetime.now().date().isoformat()
    today_result = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
    today_count = len(today_result.data) if today_result.data else 0
    
    # ì²¨ë¶€íŒŒì¼ ë³´ìœ  ë°ì´í„°
    attachment_result = supabase.table('kstartup_complete').select('id').neq('attachment_urls', '[]').execute()
    attachment_count = len(attachment_result.data) if attachment_result.data else 0
    
    print(f'ğŸ“Š K-Startup ì²˜ë¦¬ í˜„í™©')
    print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    print(f'ì „ì²´ ë°ì´í„°: {total_count}ê°œ')
    print(f'ì˜¤ëŠ˜ ì¶”ê°€: {today_count}ê°œ')
    print(f'ì²¨ë¶€íŒŒì¼ ë³´ìœ : {attachment_count}ê°œ')
    print(f'ì²˜ë¦¬ ì‹œê°„: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')'
except Exception as e:
    print(f'í†µê³„ ìƒì„± ì‹¤íŒ¨: {e}')"
