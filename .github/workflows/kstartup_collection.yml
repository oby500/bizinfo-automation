name: K-Startup Collection

on:
  workflow_dispatch:  # 수동 실행 가능
  schedule:
    # 평일 오전 7시 실행 (KST) = UTC 22:00 (전날)
    - cron: '0 22 * * 0-4'  # 일-목 UTC 22:00 = 월-금 KST 07:00

jobs:
  collect-kstartup:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4
        pip install supabase
    
    - name: Collect K-Startup Data
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup 데이터 수집 시작 ==="
        echo "실행 시간: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/kstartup_collector.py
    
    - name: Process Attachments and Generate Summary
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup 첨부파일 처리 및 요약 생성 ==="
        echo "실행 시간: $(date '+%Y-%m-%d %H:%M:%S')"
        python scripts/kstartup_complete_processor.py
    
    - name: Generate Summary Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup 처리 결과 ==="
        python -c "
import os
from supabase import create_client
from datetime import datetime

try:
    url = os.environ.get('SUPABASE_URL')
    key = os.environ.get('SUPABASE_KEY')
    supabase = create_client(url, key)
    
    # 전체 데이터
    total_result = supabase.table('kstartup_complete').select('id').execute()
    total_count = len(total_result.data) if total_result.data else 0
    
    # 오늘 추가된 데이터
    today = datetime.now().date().isoformat()
    today_result = supabase.table('kstartup_complete').select('id').gte('created_at', today).execute()
    today_count = len(today_result.data) if today_result.data else 0
    
    # 첨부파일 보유 데이터
    attachment_result = supabase.table('kstartup_complete').select('id').neq('attachment_urls', '[]').execute()
    attachment_count = len(attachment_result.data) if attachment_result.data else 0
    
    print(f'📊 K-Startup 처리 현황')
    print(f'━━━━━━━━━━━━━━━━━━━━━━')
    print(f'전체 데이터: {total_count}개')
    print(f'오늘 추가: {today_count}개')
    print(f'첨부파일 보유: {attachment_count}개')
    print(f'처리 시간: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')'
except Exception as e:
    print(f'통계 생성 실패: {e}')"
