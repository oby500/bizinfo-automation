name: Manual Fix Existing Data

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ì²˜ë¦¬ ëŒ€ìƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - bizinfo
          - kstartup
      limit:
        description: 'ì²˜ë¦¬ ê°œìˆ˜ ì œí•œ (0=ì „ì²´)'
        required: false
        default: '0'
        type: string

jobs:
  fix-data:
    name: ê¸°ì¡´ ë°ì´í„° ìˆ˜ì •
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 supabase
    
    - name: Fix BizInfo Data
      if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'bizinfo' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== ê¸°ì—…ë§ˆë‹¹ ê¸°ì¡´ ë°ì´í„° ìˆ˜ì • ==="
        echo "ëŒ€ìƒ: safe_filename ì—†ëŠ” ëª¨ë“  ë°ì´í„°"
        python scripts/bizinfo_complete_processor_fast.py
    
    - name: Fix K-Startup Data  
      if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'kstartup' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "=== K-Startup ê¸°ì¡´ ë°ì´í„° ìˆ˜ì • ==="
        echo "ëŒ€ìƒ: unknown í™•ì¥ì ë° safe_filename ì—†ëŠ” ë°ì´í„°"
        python scripts/kstartup_complete_processor_final.py
    
    - name: Generate Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        cat << 'EOF' > report.py
        import os
        from supabase import create_client
        from datetime import datetime
        import json
        
        url = os.environ.get('SUPABASE_URL')
        key = os.environ.get('SUPABASE_SERVICE_KEY')
        
        supabase = create_client(url, key)
        
        print('\n' + '='*60)
        print('          ë°ì´í„° ìˆ˜ì • ê²°ê³¼ ë³´ê³ ì„œ')
        print('='*60)
        
        # BizInfo í†µê³„
        print('\nğŸ“Š ê¸°ì—…ë§ˆë‹¹ (bizinfo_complete)')
        print('-' * 50)
        
        bizinfo = supabase.table('bizinfo_complete').select('attachment_urls').neq('attachment_urls', '[]').execute()
        
        biz_total = len(bizinfo.data) if bizinfo.data else 0
        biz_with_safe = 0
        biz_unknown = 0
        
        for item in (bizinfo.data or []):
            if item.get('attachment_urls'):
                for att in item['attachment_urls']:
                    if isinstance(att, dict):
                        if att.get('safe_filename'):
                            biz_with_safe += 1
                            if att['safe_filename'].endswith('.unknown'):
                                biz_unknown += 1
        
        print(f'ì „ì²´ ì²¨ë¶€íŒŒì¼: {biz_total}ê°œ')
        print(f'â”œâ”€ safe_filename ìˆìŒ: {biz_with_safe}ê°œ')
        print(f'â””â”€ unknown í™•ì¥ì: {biz_unknown}ê°œ')
        
        # K-Startup í†µê³„
        print('\nğŸ“Š K-Startup (kstartup_complete)')
        print('-' * 50)
        
        kstartup = supabase.table('kstartup_complete').select('attachment_urls').neq('attachment_urls', '[]').execute()
        
        k_total = len(kstartup.data) if kstartup.data else 0
        k_with_safe = 0
        k_unknown = 0
        
        for item in (kstartup.data or []):
            if item.get('attachment_urls'):
                for att in item['attachment_urls']:
                    if isinstance(att, dict):
                        if att.get('safe_filename'):
                            k_with_safe += 1
                            if att['safe_filename'].endswith('.unknown'):
                                k_unknown += 1
        
        print(f'ì „ì²´ ì²¨ë¶€íŒŒì¼: {k_total}ê°œ')
        print(f'â”œâ”€ safe_filename ìˆìŒ: {k_with_safe}ê°œ')
        print(f'â””â”€ unknown í™•ì¥ì: {k_unknown}ê°œ')
        
        # ê°œì„  íš¨ê³¼
        print('\nâœ¨ ê°œì„  íš¨ê³¼')
        print('-' * 50)
        
        if biz_unknown == 0 and k_unknown == 0:
            print('âœ… ëª¨ë“  íŒŒì¼ í™•ì¥ìê°€ ì •ìƒì…ë‹ˆë‹¤!')
        else:
            if biz_unknown > 0:
                print(f'âš ï¸ ê¸°ì—…ë§ˆë‹¹: {biz_unknown}ê°œ unknown í™•ì¥ì ë‚¨ìŒ')
            if k_unknown > 0:
                print(f'âš ï¸ K-Startup: {k_unknown}ê°œ unknown í™•ì¥ì ë‚¨ìŒ')
        
        print('\n' + '='*60)
        print(f'ë³´ê³ ì„œ ìƒì„±: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
        print('='*60)
        
        EOF
        python report.py
